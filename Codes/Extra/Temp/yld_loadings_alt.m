m=[3.9149	7.7142	0.80243	0.565
3.956	7.5342	0.10505	0.45716
3.8818	7.5583	0.64399	0.37118
3.9431	8.6365	0.80956	0.46667
4.0961	8.466	1.0167	0.4008
4.0145	8.6938	1.1405	0.16171
3.9286	8.1169	0.90307	0.17438
4.0237	6.9672	1.0555	-0.19029
3.9098	6.53	0.66264	-0.12873
3.7153	5.5041	0.57263	-0.51455
3.729	6.0242	0.98036	-0.40282
3.7586	6.6451	0.70368	-0.26062
3.8355	5.9888	0.72016	-0.3928
3.8033	5.4876	0.36772	-0.45244
3.6023	4.5314	0.61422	-0.66992
3.5314	5.0071	0.85855	-0.6165
3.5495	5.177	1.0031	-0.49944
3.499	4.4761	0.33605	-0.65574
3.4798	4.6388	0.68623	-0.67747
3.3698	5.2455	0.79942	-0.44808
3.5332	5.96	0.58204	-0.24119
3.6788	5.9899	0.66387	-0.38267
3.8591	7.7577	0.9647	-0.028431
3.8336	7.9426	0.93054	-0.027444
3.8805	7.1087	0.60559	-0.1552
4.023	7.6955	0.6954	-0.12228
4.2029	7.5643	0.46702	-0.29788
4.2639	7.8748	0.30048	-0.36473
4.3655	8.425	0.47882	-0.27226
4.5061	9.333	0.5187	-0.095058
4.7635	9.2068	0.2355	-0.20624
4.789	9.3408	0.099379	-0.18054
4.6708	8.7186	0.042814	-0.23621
4.6759	8.3754	-0.20943	-0.2711
4.6913	8.0605	-0.26806	-0.3362
4.5633	7.5006	-0.49716	-0.26447
4.5998	7.346	-0.70904	-0.21815
4.5783	7.5197	-0.68362	-0.18936
4.7469	8.0615	-0.90929	-0.061608
4.6731	7.6518	-0.91529	-0.10276
4.634	7.177	-1.0948	-0.21045
4.4926	6.4631	-1.0587	-0.2613
4.3423	5.6145	-1.1987	-0.19614
4.3814	5.9629	-1.1071	-0.083812
4.2906	5.601	-1.3053	-0.11121
4.068	5.8548	-0.97378	-0.077448
4.3712	6.1289	-1.3031	0.067271
4.3589	6.0001	-1.4451	0.093767
4.3585	5.5024	-1.7379	0.12314
4.4395	5.9543	-1.821	0.2535
4.3417	5.8926	-1.7299	0.3399
4.3355	6.3394	-1.3916	0.32088
4.4081	7.0012	-0.98172	0.29187
4.4033	7.0171	-1.2117	0.34299
4.3813	7.0988	-1.1308	0.34556
4.4408	7.0755	-1.3012	0.32767
4.7397	7.4968	-1.575	0.11363
4.7747	7.5704	-1.673	0.17017
4.8974	7.9045	-1.9021	0.28363
4.9376	8.0496	-1.8531	0.29051
5.0315	8.7189	-1.6605	0.3916
5.28	9.6463	-1.5981	0.3567
5.2427	9.0312	-1.8396	0.24254
5.3255	9.5978	-1.509	0.2078
5.4784	9.8986	-1.5024	0.12931
5.4008	10.435	-1.4402	0.41046
5.5469	11.064	-1.258	0.47179
5.678	10.73	-1.5315	0.28856
5.3095	9.9897	-1.3659	0.16418
4.9864	8.8718	-1.0592	0.087113
5.4701	9.2598	-1.5288	-0.10643
4.7838	7.9248	-0.8766	-0.14457
4.5786	7.0995	-0.96636	-0.10212
4.6284	7.2047	-0.76555	-0.32965
4.6623	6.7672	-0.57964	-0.58607
4.3456	6.5627	-0.61411	-0.50132
4.284	7.2398	-0.20909	-0.16822
4.821	8.8769	-0.62061	-0.045429
4.855	9.2231	-0.56806	0.14467
4.7111	7.6344	-0.8144	-0.14655
4.6223	6.7315	-0.92231	-0.23261
2.1196	3.569	1.2191	0.57275
3.4312	3.325	1.6431	-0.10044
0.84989	-1.641	3.2764	-0.088406
1.0043	-2.4024	1.8705	0.31997
0.75423	-2.4392	2.9623	-0.18581
0.73213	-2.2718	2.8535	-0.66856
0.37083	-3.0282	2.7072	-0.27604
0.22743	-2.555	3.0525	-0.15944
0.41141	-2.0353	3.1679	-0.10108
0.25484	-1.4366	3.2785	0.44872
0.20252	-1.2495	3.6014	0.45445
0.13979	-2.0317	3.0743	0.47523
0.16532	-2.1112	3.0767	0.47757
0.22758	-1.8862	2.9647	0.41375
0.35306	-2.2265	2.8051	0.1686
0.32577	-1.6467	3.06	0.34678
0.31227	-1.8606	3.0265	0.31217
0.35598	-2.294	3.0309	-0.063955
0.31831	-2.2051	2.958	0.052935
0.36376	-2.0647	2.9099	0.12746
0.24136	-3.6647	2.496	-0.22272
0.37318	-3.65	2.1802	-0.35732
0.53225	-3.0673	2.2709	-0.47038
0.57017	-2.7691	2.9346	1.8064
0.61412	-2.6127	2.9817	1.721
0.71381	-2.0372	3.4035	1.3891
0.57886	-2.1935	3.5343	1.3402
0.66523	-1.6561	3.1929	1.1192
0.62232	-0.94144	3.7617	0.93359
0.67138	-0.81886	3.3299	1.0994
0.71618	-0.66603	3.3836	1.0396
0.66	-1.6731	2.5839	-0.23242
0.66658	-2.4323	2.2161	-0.53298
0.63436	-2.4175	2.6688	-0.73581
0.79134	-3.4276	1.745	-1.1606
0.64411	-4.1502	1.3857	-1.267
0.51785	-5.0379	0.48151	-0.92731
0.61916	-4.5901	0.64773	-0.84928
0.53618	-5.4653	-0.16904	-0.81123
0.51142	-5.567	-0.18605	-0.92374
0.52371	-5.4628	-0.050054	-0.92769
0.51027	-5.0287	0.40824	-0.93904
0.4781	-4.8268	0.72836	-0.92557
0.47543	-4.8344	0.58668	-0.90491
0.43498	-6.332	-0.58909	-1.0131
0.35871	-6.0008	-0.16157	-0.88587
0.23322	-6.7198	-0.23478	-0.99647
0.36311	-6.6471	-0.56121	-0.9664
0.35557	-6.415	-0.49141	-0.93471
0.3602	-6.1832	-0.30998	-0.88309
0.37262	-6.3679	-0.57728	-0.87185
0.33914	-6.4254	-0.54008	-0.86644
0.3886	-5.906	-0.0050388	-0.90435
0.4175	-6.2662	-0.10901	-1.0777
0.38507	-6.7372	-0.59188	-1.1196
0.39504	-6.7424	-0.75183	-1.0209
0.35372	-6.0867	-0.18745	-0.8586
0.50863	-5.1096	0.41036	-0.55493
0.42072	-5.5157	0.44578	-0.66784
0.43273	-4.8967	0.63384	-0.30044
0.3872	-4.7834	0.77028	-0.31486
0.43865	-4.7478	0.67318	-0.36631
0.5274	-4.3012	0.96472	-0.3339
0.52041	-3.499	1.374	0.14332
0.50076	-4.2137	0.81844	-0.0075681
0.52038	-4.1481	0.81855	-0.0063061
0.54109	-3.9436	0.84045	0.14949
0.49402	-3.9235	0.82732	0.19095
0.49233	-4.0837	0.6471	0.13766
0.50679	-3.5643	0.67132	0.31889
0.54765	-3.7946	0.3631	0.41254
0.49588	-4.5777	-0.249	0.38817
0.49471	-4.3718	-0.037887	0.39591
0.46318	-4.7721	-0.211	0.29043
0.52532	-5.5555	-0.83771	0.19333
0.47287	-5.787	-1.2211	0.30347
0.45103	-6.7636	-1.989	0.28675
0.39727	-5.8609	-1.1045	0.34663
0.48829	-6.3267	-1.5654	0.23622
0.36088	-5.7719	-0.9174	0.24022
0.39927	-5.7055	-0.89603	0.1942
0.46187	-5.1884	-0.56419	0.25276
0.43509	-5.3127	-0.83463	0.39644
0.43224	-5.271	-0.86519	0.38214
0.25594	-5.6753	-0.80636	0.30626
0.41416	-5.307	-0.67034	0.31434
0.42533	-5.3932	-0.80463	0.29616
0.53676	-4.9615	-0.66688	0.34239
0.45238	-6.1123	-1.2172	0.12686
0.47408	-6.9479	-1.8943	0.036198
0.41151	-6.622	-1.4598	0.097648
0.37345	-6.3616	-1.2434	0.16808
0.38387	-6.4393	-1.3448	0.21632
0.12499	-8.1523	-2.0955	0.13442
-0.088531	-8.8493	-2.3181	0.21857
-0.17542	-9.0599	-2.3838	0.29133
-0.22362	-8.7723	-2.0611	0.15548
-0.24498	-7.799	-1.2101	0.19987
-0.20359	-7.3428	-0.77447	0.26972
-0.2043	-7.7512	-1.1044	0.24711
-0.19387	-7.5662	-0.83634	0.26332
-0.18288	-8.3673	-1.4472	0.1877
0.1107	-7.7054	-1.5495	0.10025
0.040572	-7.8854	-1.5034	0.01826
0.12132	-7.7509	-1.5824	0.0098892
0.1163	-7.1778	-1.4464	0.25238
0.030782	-7.4686	-1.3951	0.19877
0.060167	-7.8639	-1.7583	0.20829
0.10816	-6.8886	-1.4044	0.34015
0.17195	-6.8494	-1.6079	0.3708
0.23611	-6.7087	-1.731	0.45873
0.44708	-6.8172	-2.1272	0.42442
0.28143	-6.2595	-1.5686	0.62176
0.2233	-6.1926	-1.4159	0.62614
0.37883	-6.1118	-1.7924	0.60413
0.21216	-6.2583	-1.5465	0.65383
0.3267	-6.5331	-1.8381	0.54665
0.24486	-6.085	-1.6862	0.64582
0.45336	-5.7369	-1.8309	0.65791
0.55359	-5.7669	-1.9294	0.56389
0.34651	-5.5322	-1.649	0.62513
0.3037	-5.5009	-1.6033	0.49681
0.6037	-5.1996	-1.6215	0.33125
0.95173	-5.0572	-2.0278	0.36448
0.72044	-5.6563	-2.1052	0.32338];
% m = [yields(:,1) PCs];
r=m(:,1)/1200;  %Decimal per month
pc=m(:,2:4)/100;
bigt=length(r);

x=[ones(bigt,1) pc];
delta=inv(x'*x)*x'*r;
delta0=delta(1); delta1=delta(2:end);

[wmu, wphi, wSigma] = VAR1(pc);
% wmu=[-0.064517181;
% -0.013939814;
% -0.001182721];
% wphi=[0.991951124	-0.037935657	0.059243174
% 0.002001495	0.97081092	-0.000468213
% -0.00208146	-0.011951254	0.883204018];
% wSigma=[0.490571773	0.038736978	0.036626498
% 0.038736978	0.161939863	0.023961323
% 0.036626498	0.023961323	0.058559077];

A(1,1)=-delta0;
B(:,1)=-delta1;
for i=1:120
    A(i+1,1)=-delta0+A(i,1)+(B(:,i)'*wmu)+(0.5*B(:,i)'*wSigma*B(:,i));
    B(:,i+1)=(wphi'*B(:,i))-delta1;
end

A2(1,1)=-delta0;
B2(:,1)=-delta1;
for i=1:120
    A2(i+1,1)=-delta0+A2(i,1)+(B2(:,i)'*wmu);
    B2(:,i+1)=(wphi'*B2(:,i))-delta1;
end

% A120 = -A(120)/10; B120 = -B(:,120)/10;

for t=1:bigt
P10=exp(A(120)+(pc(t,:)*B(:,120)));
y10(t,1)=-100*log(P10)/10;
y10direct(t,1) = -(A(120)+(pc(t,:)*B(:,120)))*100/10;

P10=exp(A2(120)+(pc(t,:)*B2(:,120)));
y10(t,2)=-100*log(P10)/10;
y10direct(t,2) = -(A2(120)+(pc(t,:)*B2(:,120)))*100/10;
end

figure
plot(y10(:,1));
hold on
plot(y10(:,2),'r');
legend({'With convexity adjustment','Without convexity adjustment'})

% wrgtA = A; wrgtB = B; wrgtA2 = A2; wrgtB2 = B2; wrgty10 = y10;
% Equivalent: 
% [Ay,By] = loadings4ylds(maturities,mu,phi,Sigma,delta0,delta1,dt);
% yields_exp      = ones(nobs,1)*Ay + PCs*By;
% z1 = yields_exp(:,12)*100;
% 
% [A2y,B2y] = loadings4ylds(maturities,mu,phi,zeros(size(Sigma)),delta0,delta1,dt);
% yields_exp      = ones(nobs,1)*Ay + PCs*By;
% z2 = yields_exp(:,12)*100;
% plot([z1 z2])